open import Data.Product renaming (_,_ to âŸ¨_,_âŸ©)
open import Data.Vec
open import Data.Nat

module Adjoint.Core.Rules 
  (Atom : Set)
  (Mode : Set)
  (mWeakenable : Mode â†’ Set)
  (mContractable : Mode â†’ Set)
  (mHarmless : Mode â†’ Set)
  (_âˆ™_â‡’_ : Mode â†’ Mode â†’ Mode â†’ Set)
  (_â‰¥_ : Mode â†’ Mode â†’ Set) 
  where
  
  open import Adjoint.Core.Props Atom Mode
  open import Adjoint.Core.Contexts 
    Atom 
    Mode  
    mWeakenable 
    mContractable 
    mHarmless 
    _âˆ™_â‡’_ 
    _â‰¥_ 

  private
    variable
      n : â„•
      Î” Î”' Î”â‚ Î”â‚‚ Î”â‚ƒ Î”â‚â‚‚ Î”â‚‚â‚ƒ Î”â‚â‚‚' Î”â‚‚â‚ƒ' : Context n
      m k l : Mode
      A B C : Prop 
  
  data _âŠ¢_ : Context n â†’ ModedProp â†’ Set where

    id : update Î” âŸ¨ A , m âŸ© âŸ¨ A , k âŸ© Î”' â†’ cWeakenable Î”' â†’ mHarmless k
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ A , m âŸ©

    cut : merge Î”â‚ Î”â‚‚ Î”â‚â‚‚ â†’ merge Î”â‚‚ Î”â‚ƒ Î”â‚‚â‚ƒ â†’ merge Î”â‚â‚‚ Î”â‚ƒ Î”
      â†’ Î”â‚ â‰¥á¶œ m â†’ Î”â‚‚ â‰¥á¶œ m â†’ m â‰¥ k
      â†’ cContractable Î”â‚‚
      â†’ Î”â‚â‚‚ âŠ¢ âŸ¨ A , m âŸ©
      â†’ (âŸ¨ A , m âŸ© âˆ· Î”â‚‚â‚ƒ) âŠ¢ âŸ¨ C , k âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ C , k âŸ©

    âŠ•Râ‚ : Î” âŠ¢ âŸ¨ A , m âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ A âŠ• B , m âŸ©

    âŠ•Râ‚‚ : Î” âŠ¢ âŸ¨ B , m âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ A âŠ• B , m âŸ©

    âŠ•L : mayConsume Î” âŸ¨ A âŠ• B , m âŸ© Î”'
      â†’  (âŸ¨ A , m âŸ© âˆ· Î”') âŠ¢ âŸ¨ C , k âŸ© â†’ (âŸ¨ B , m âŸ© âˆ· Î”') âŠ¢ âŸ¨ C , k âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ C , k âŸ©

    &R : Î” âŠ¢ âŸ¨ A , m âŸ© â†’ Î” âŠ¢ âŸ¨ B , m âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ A & B , m âŸ©

    &Lâ‚ : mayConsume Î” âŸ¨ A & B , m âŸ© Î”'
      â†’  (âŸ¨ A , m âŸ© âˆ· Î”') âŠ¢ âŸ¨ C , k âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ C , k âŸ©

    &Lâ‚‚ : mayConsume Î” âŸ¨ A & B , m âŸ© Î”'
      â†’  (âŸ¨ B , m âŸ© âˆ· Î”') âŠ¢ âŸ¨ C , k âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ C , k âŸ©

    âŠ—R : merge Î”â‚ Î”â‚‚ Î”â‚â‚‚ â†’ merge Î”â‚‚ Î”â‚ƒ Î”â‚‚â‚ƒ â†’ merge Î”â‚â‚‚ Î”â‚ƒ Î”
      â†’ cContractable Î”â‚‚
      â†’ Î”â‚â‚‚ âŠ¢ âŸ¨ A , m âŸ© â†’ Î”â‚‚â‚ƒ âŠ¢ âŸ¨ B , m âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ A âŠ— B , m âŸ©

    âŠ—L : mayConsume Î” âŸ¨ A âŠ— B , m âŸ© Î”'
      â†’ (âŸ¨ B , m âŸ© âˆ· âŸ¨ A , m âŸ© âˆ· Î”') âŠ¢ âŸ¨ C , k âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ C , k âŸ©

    âŠ¸R : (âŸ¨ A , m âŸ© âˆ· Î”) âŠ¢ âŸ¨ B , m âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ A âŠ¸ B , m âŸ©

    âŠ¸L : merge Î”â‚ Î”â‚‚ Î”â‚â‚‚ â†’ merge Î”â‚‚ Î”â‚ƒ Î”â‚‚â‚ƒ â†’ merge Î”â‚â‚‚ Î”â‚ƒ Î”
      â†’ mayConsume Î”â‚â‚‚ âŸ¨ A âŠ¸ B , m âŸ© Î”â‚â‚‚'
      â†’ mayConsume Î”â‚‚â‚ƒ âŸ¨ A âŠ¸ B , m âŸ© Î”â‚‚â‚ƒ'
      â†’ Î”â‚ â‰¥á¶œ m â†’ Î”â‚‚ â‰¥á¶œ m â†’ cContractable Î”â‚‚
      â†’ Î”â‚â‚‚ âŠ¢ âŸ¨ A , m âŸ©
      â†’ (âŸ¨ B , m âŸ© âˆ· Î”â‚‚â‚ƒ) âŠ¢ âŸ¨ C , k âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ C , k âŸ©

    ğŸ™R : cWeakenable Î”
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ ğŸ™ , m âŸ©

    ğŸ™L : mayConsume Î” âŸ¨ ğŸ™ , m âŸ© Î”' â†’ Î”' âŠ¢ âŸ¨ C , k âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ C , k âŸ©

    â†“R : merge Î”â‚ Î”â‚‚ Î”
      â†’ Î”â‚ â‰¥á¶œ m 
      â†’ cWeakenable Î”â‚‚
      â†’ Î”â‚ âŠ¢ âŸ¨ A , m âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ â†“[ k ][ m ] A , k âŸ©

    â†“L : mayConsume Î” âŸ¨ â†“[ k ][ m ] A , k âŸ© Î”'
      â†’ (âŸ¨ A , m âŸ© âˆ· Î”') âŠ¢ âŸ¨ C , l âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ C , l âŸ©

    â†‘R : Î” âŠ¢ âŸ¨ A , m âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ â†‘[ k ][ m ] A , k âŸ©

    â†‘L : mayConsume Î” âŸ¨ â†‘[ k ][ m ] A , k âŸ© Î”' â†’ k â‰¥ l
      â†’ (âŸ¨ A , m âŸ© âˆ· Î”') âŠ¢ âŸ¨ C , l âŸ©
      ----------------------------------------------------------
      â†’ Î” âŠ¢ âŸ¨ C , l âŸ©
 